{% extends 'base.html.twig' %}

{% block body %}
<div class="p-4 flex justify-between items-center">
    <div class="flex justify-center items-center">
        <svg width="27" height="27" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M31.25 14.1111V32.2778H4V14.1111L17.625 2L31.25 14.1111Z" stroke="#4B515D" stroke-width="2.14697"
                stroke-linejoin="round" />
            <path
                d="M4 17.139H31.25M9.29861 9.56958V32.2779M25.9514 9.56958V32.2779M14.5972 23.1946H20.6528V32.2779H14.5972V23.1946Z"
                stroke="#4B515D" stroke-width="2.14697" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <h1 class="text-2xl font-bold mt-1 ml-2">Vue des categories</h1>
    </div>

    <div class="flex justify-between items-center">
        {% if session.username is defined %}
        <div class="mr-2">
            <p>{{session.username}}</p>
            <div class="flex flex-row-reverse">
                {% if session.role_id == 1 %}
                <p class="text-zinc-600 text-xs font-light">Admin</p>
                {% else %}
                <p class="text-zinc-600 text-xs font-light">Gestionnaire</p>
                {% endif %}
            </div>
        </div>
        <img src="img/pfp.png" alt="" class="w-12 h-12 rounded-full">
        {% endif %}
    </div>
</div>

<div class="mt-2 w-full h-5/6 flex justify-center items-center">
    <section class="w-9/12 p-8 border border-gray-200 bg-neutral-50 rounded-md shadow-lg">

        {% if session.role_id == 1 %}
        <a href="controleur.php?page=categories&action=create" class="inline-block mb-4 px-4 py-2 text-green-600 rounded hover:bg-green-50 border border-green-600 transition duration-200 cursor-pointer">
            Ajouter une catégorie
        </a>
        {% endif %}
        <div class="sm:rounded-t-lg mb-4">
            <table class="w-full text-sm text-left rtl:text-right ">
                <thead class=" text-xs uppercase bg-gray-200  ">
                    <tr>
                        <th scope="col" class="px-6 py-4">Id</th>
                        <th scope="col" class="px-6 py-4">Nom</th>
                        <th scope="col" class="px-6 py-4">Action</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% for element in categories %}
                        <tr class="document-item odd:bg-neutral-50 even:bg-gray-100">
                            <td id="id-{{ element.idt }}" class="px-6 py-4">{{ element.idt }}</td>
                            <td id="name-{{ element.idt }}" class="px-6 py-4">{{ element.label_type_doc }}</td>
                            <td class="px-6 py-4 flex space-x-2 flex items-center">
                                {% if session.username is defined %}
                                <div id="edit-{{ element.idt }}" onclick="editRow('{{ element.idt }}')" class="action-button edit w-6 h-6 border border-green-500 rounded flex justify-center items-center hover:bg-green-50 transition duration-200 cursor-pointer">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_177_1499)">
                                        <path d="M5.81815 13.7164L0.909058 15.091L2.2836 10.1819L11.2727 1.23643C11.3743 1.13253 11.4957 1.04997 11.6295 0.993603C11.7635 0.937238 11.9074 0.908203 12.0527 0.908203C12.198 0.908203 12.3419 0.937238 12.4759 0.993603C12.6097 1.04997 12.7311 1.13253 12.8327 1.23643L14.7636 3.17825C14.8658 3.27966 14.947 3.40032 15.0024 3.53325C15.0578 3.66619 15.0863 3.80878 15.0863 3.95279C15.0863 4.0968 15.0578 4.2394 15.0024 4.37233C14.947 4.50527 14.8658 4.62593 14.7636 4.72734L5.81815 13.7164Z" stroke="#02986A" stroke-linecap="round" stroke-linejoin="round"/>
                                        </g>
                                        <defs>
                                        <clipPath id="clip0_177_1499">
                                        <rect width="15.2727" height="15.2727" fill="white" transform="translate(0.363647 0.36377)"/>
                                        </clipPath>
                                        </defs>
                                        </svg>
                                        
                                </div>
                                <div id="save-{{ element.idt }}" onclick="saveRow('{{ element.idt }}')" class="action-button save px-4 py-1 border border-green-500 rounded flex justify-center items-center hover:bg-green-50 transition duration-200 hidden cursor-pointer">
                                    <p class="text-green-600">Valider</p>
                                </div>
                                <div id="cancel-{{ element.idt }}" onclick="cancelEdit('{{ element.idt }}')" class="action-button cancel w-6 h-6 border border-red-500 rounded flex justify-center items-center hover:bg-red-50 transition duration-200 hidden cursor-pointer">
                                    <svg width="12" height="12" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_234_2381)">
                                        <path d="M13.5 0.5L0.5 13.5" stroke="red" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M0.5 0.5L13.5 13.5" stroke="red" stroke-linecap="round" stroke-linejoin="round"/>
                                        </g>
                                        <defs>
                                        <clipPath id="clip0_234_2381">
                                        <rect width="14" height="14" fill="white"/>
                                        </clipPath>
                                        </defs>
                                        </svg>
                                </div>
                                {% endif %}
                                {% if session.role_id == 1 %}
                                    <a href="controleur.php?page=categories&action=delete&id={{ element.idt }}">
                                        <div class="w-6 h-6 border border-red-500 rounded flex justify-center items-center hover:bg-red-50 transition duration-200 cursor-pointer">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <g clip-path="url(#clip0_177_1489)">
                                                <path d="M1.45459 4.18213H14.5455" stroke="#EF4565" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M3.09094 4.18213H12.9091V14.0003C12.9091 14.2896 12.7941 14.5671 12.5896 14.7717C12.3851 14.9762 12.1075 15.0912 11.8182 15.0912H4.18185C3.89252 15.0912 3.61505 14.9762 3.41046 14.7717C3.20588 14.5671 3.09094 14.2896 3.09094 14.0003V4.18213Z" stroke="#EF4565" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M5.27283 4.18191V3.63645C5.27283 2.91314 5.56016 2.21944 6.07162 1.70798C6.58309 1.19652 7.27678 0.90918 8.0001 0.90918C8.72342 0.90918 9.41711 1.19652 9.92858 1.70798C10.44 2.21944 10.7274 2.91314 10.7274 3.63645V4.18191" stroke="#EF4565" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M6.36365 7.45605V11.8214" stroke="#EF4565" stroke-linecap="round" stroke-linejoin="round"/>
                                                <path d="M9.63635 7.45605V11.8214" stroke="#EF4565" stroke-linecap="round" stroke-linejoin="round"/>
                                                </g>
                                                <defs>
                                                <clipPath id="clip0_177_1489">
                                                <rect width="15.2727" height="15.2727" fill="white" transform="translate(0.363647 0.36377)"/>
                                                </clipPath>
                                                </defs>
                                                </svg>
                                                
                                        </div>
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="pagination flex justify-between items-center mt-4">
                <div class="w-40 flex items-center justify-between">
                    <button id="prev-btn"
                        class="px-1 py-1 text-blue-600 rounded hover:bg-blue-50 border border-blue-300 transition duration-200">
                        <svg width="17" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10.4415 4.94L9.50146 4L5.50146 8L9.50146 12L10.4415 11.06L7.38813 8L10.4415 4.94Z" fill="blue" fill-opacity="0.54" />
                        </svg>
                    </button>
                    <span id="page-indicator" class="text-xs"></span>
                    <button id="next-btn"
                        class="px-1 py-1 text-blue-600 rounded hover:bg-blue-50 border border-blue-300 transition duration-200">
                        <svg width="17" height="16" viewBox="0 0 17 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.83453 4L5.89453 4.94L8.94786 8L5.89453 11.06L6.83453 12L10.8345 8L6.83453 4Z" fill="blue" fill-opacity="0.54" />
                        </svg>
                    </button>
                </div>
            
                <div class="flex items-center">
                    <label for="page-select" class="mr-2 text-xs">Aller à la page :</label>
                    <input type="number" id="page-select" min="1" max="1" value="1"
                        class="w-10 border border-blue-300 rounded px-2 py-1">
                </div>
            </div>
            
        </div>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rowsPerPage = 6;
        let currentPage = 1;
    
        const tableBody = document.getElementById('table-body');
        const rows = Array.from(tableBody.getElementsByClassName('document-item'));
    
        function renderTable() {
            tableBody.innerHTML = '';
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
    
            for (let i = start; i < end && i < rows.length; i++) {
                tableBody.appendChild(rows[i]);
            }
    
            document.getElementById('page-indicator').innerText = `Page ${currentPage} sur ${Math.ceil(rows.length / rowsPerPage)}`;
            document.getElementById('page-select').value = currentPage;
            document.getElementById('page-select').max = Math.ceil(rows.length / rowsPerPage);
    
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === Math.ceil(rows.length / rowsPerPage);
        }
    
        document.getElementById('prev-btn').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });
    
        document.getElementById('next-btn').addEventListener('click', function() {
            if (currentPage < Math.ceil(rows.length / rowsPerPage)) {
                currentPage++;
                renderTable();
            }
        });
    
        document.getElementById('page-select').addEventListener('change', function(event) {
            const selectedPage = parseInt(event.target.value, 10);
            if (selectedPage >= 1 && selectedPage <= Math.ceil(rows.length / rowsPerPage)) {
                currentPage = selectedPage;
                renderTable();
            }
        });
    
        renderTable();
    
        // Existing functions for editing and saving rows
        window.editRow = function(id) {
            document.getElementById('edit-' + id).classList.add('hidden');
            document.getElementById('save-' + id).classList.remove('hidden');
            document.getElementById('cancel-' + id).classList.remove('hidden');
            
            let nameCell = document.getElementById('name-' + id);
            nameCell.contentEditable = "true";
            nameCell.classList.add('border-2', 'border-blue-500', 'bg-white');
        }
        
        window.saveRow = function(id) {
            let nameCell = document.getElementById('name-' + id);
            let newName = nameCell.innerText;
        
            // Send the updated data to the server via AJAX
            fetch('controleur.php?page=categories&action=update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id,
                    label: newName,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('edit-' + id).classList.remove('hidden');
                    document.getElementById('save-' + id).classList.add('hidden');
                    document.getElementById('cancel-' + id).classList.add('hidden');
        
                    nameCell.contentEditable = "false";
                    nameCell.classList.remove('border-2', 'border-blue-500', 'bg-white');
        
                    // Afficher le toast
                    Toastify({
                        text: "Modification enregistrée",
                        duration: 3000,
                        close: true,
                        gravity: "top", // `top` ou `bottom`
                        position: "right", // `left`, `center` ou `right`
                        backgroundColor: "#4CAF50",
                        stopOnFocus: true, // Arrêter le timer à l'arrêt de la souris sur le toast
                    }).showToast();
                } else {
                    // Handle the error
                    alert('Erreur lors de la mise à jour.');
                }
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
        
        window.cancelEdit = function(id) {
            document.getElementById('edit-' + id).classList.remove('hidden');
            document.getElementById('save-' + id).classList.add('hidden');
            document.getElementById('cancel-' + id).classList.add('hidden');
            
            let nameCell = document.getElementById('name-' + id);
            nameCell.contentEditable = "false";
            nameCell.classList.remove('border-2', 'border-blue-500', 'bg-white');
            
            // Reload the page to reset the table data
            location.reload();
        }
    });
    
</script>
        
    

{% endblock %}
