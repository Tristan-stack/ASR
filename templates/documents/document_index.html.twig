{% extends 'base.html.twig' %}

{% block body %}

<div>

    <div class="p-4 flex justify-between items-center">
        <div class="flex justify-center items-center">
            <svg width="27" height="27" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M31.25 14.1111V32.2778H4V14.1111L17.625 2L31.25 14.1111Z" stroke="#4B515D"
                    stroke-width="2.14697" stroke-linejoin="round" />
                <path
                    d="M4 17.139H31.25M9.29861 9.56958V32.2779M25.9514 9.56958V32.2779M14.5972 23.1946H20.6528V32.2779H14.5972V23.1946Z"
                    stroke="#4B515D" stroke-width="2.14697" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <h1 class="text-2xl font-bold mt-1 ml-2">Vue des rapports</h1>
        </div>

        <div class="flex justify-between items-center">
            {% if session.username is defined %}
            <div class="mr-2">
                <p>{{session.username}}</p>
                <div class="flex flex-row-reverse">
                    {% if session.role_id == 1 %}
                    <p class="text-zinc-600 text-xs font-light">Admin</p>
                    {% else %}
                    <p class="text-zinc-600 text-xs font-light">Gestionnaire</p>
                    {% endif %}
                </div>
            </div>
            <img src="img/pfp.png" alt="" class="w-12 h-12 rounded-full">
            {% endif %}
        </div>
    </div>

    <div class="mt-2 w-full h-5/6 flex justify-center items-center">

        <section class="w-10/12 p-8 border-solid border border-gray-200 bg-neutral-50 rounded-md shadow-lg">
            {% if session.role_id in [1, 2] %}
            <a href="controleur.php?page=documents&action=uploadedToday">
                <h3
                    class="inline-block mb-4 px-4 py-2 text-green-600 rounded hover:bg-green-50 border border-green-600 transition duration-200 cursor-pointer">
                    Ajouter un rapport</h3>
            </a>
            {% endif %}
            <div class="  mb-4   border-solid border-b border-gray-200">
                <div>
                    <form method="POST" action="controleur.php?page=documents&action=read"
                        class="w-full flex justify-between">
                        <div>

                            <select id="date" name="date" class="p-2 text-blue-600 rounded border border-blue-300">
                                {% set lastFiveYears = availableDates|filter(year => year >= currentYear - 5) %}
                                {% for year in lastFiveYears %}
                                    <option value="{{ year|e }}">{{ year|e }}</option>
                                {% endfor %}
                            </select>
                            <input type="submit" value="Appliquer"
                                class="mr-2 px-4 py-2 text-blue-600 rounded hover:bg-blue-50 border border-blue-300 transition duration-200 cursor-pointer">
                        </div>

                        <input type="text" id="search" placeholder="Rechercher..." aria-label="Rechercher"
                            class="p-2 ml-1 text-blue-600 rounded hover:bg-blue-50 border border-blue-300 transition duration-200">
                    </form>

                </div>
                <div class="flex justify-center mt-4 space-x-4">
                    {% for type_doc, label in { 3: 'Rapport Eau', 4: 'Rapport ASS', 5:
                    'Rapport ANC', 6: 'Rapport GCE'} %}
                    {% set color_class = type_doc == 3 ? 'blue-500' : type_doc == 4 ? 'amber-700' : type_doc == 5 ? 'purple-400' : 'emerald-400' %}
                    <button
                        class="document-type-btn  category-button mb-4 mt-2 px-4 py-2 text-dark text-xs rounded-full border border-{{ color_class }} transition duration-200"
                        data-type="{{ type_doc }}">{{ label }}</button>
                    {% endfor %}
                </div>

            </div>

            <div id="loader" style="display: none;">
                <svg aria-hidden="true" class="w-8 h-8 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="sr-only">Loading...</span>
            </div>
            
            <div class="sm:rounded-t-lg mb-4">
                <table class="w-full h-6/12 text-sm text-left rtl:text-right " id="documents-container">
                    <thead class="  text-xs uppercase bg-gray-200  ">
                        <tr>
                            <th scope="col" class="px-6 py-4">
                                Id
                            </th>
                            <th scope="col" class="px-6 py-4">
                                Nom
                            </th>
                            <th scope="col" class="px-6 py-4">
                                Code Postal
                            </th>
                            <th scope="col" class="px-6 py-4">
                                Categorie
                            </th>
                            <th scope="col" class="px-6 py-4">
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category_name, documents in documentsByCategory %}
                        {% for document in documents %}
                        <tr class="document-item hidden odd:bg-neutral-50 even:bg-gray-100"
                            data-type="{{ document.type_doc }}">
                            <td class="px-6 py-4">{{ document.idt_doc|e }}</td>
                            <td class="px-6 py-4">{{ document.titre|e }}</td>
                            <td class="px-6 py-4">{{ document.link|e }}</td>
                            <td class="px-6 py-4">
                                <span
                                    class="inline-block w-4 h-4 rounded-full text-center text-white px-2 bg-{{ document.type_doc == 1 ? 'gray-500' : document.type_doc == 2 ? 'rose-400' : document.type_doc == 3 ? 'blue-500' : document.type_doc == 4 ? 'amber-900' : document.type_doc == 5 ? 'purple-400' : 'emerald-400' }}"
                                    data-type="{{ document.type_doc }}"></span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-row">

                                    <a href="controleur.php?page=documents&id={{ document.idt_doc }}">
                                        <div
                                            class="w-6 h-6 border border-blue-300 rounded flex justify-center items-center hover:bg-blue-50 transition duration-200">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <g clip-path="url(#clip0_273_132)">
                                                    <path
                                                        d="M14.7967 7.17778C14.9775 7.4033 15.0777 7.69628 15.0777 8.00007C15.0777 8.30385 14.9775 8.59684 14.7967 8.82235C13.6512 10.2092 11.0439 12.9092 8.00028 12.9092C4.95664 12.9092 2.34937 10.2092 1.20391 8.82235C1.023 8.59684 0.922852 8.30385 0.922852 8.00007C0.922852 7.69628 1.023 7.4033 1.20391 7.17778C2.34937 5.79094 4.95664 3.09091 8.00028 3.09091C11.0439 3.09091 13.6512 5.79094 14.7967 7.17778Z"
                                                        stroke="#5AB1CB" stroke-linecap="round"
                                                        stroke-linejoin="round" />
                                                    <path
                                                        d="M8.00018 10.1818C9.20516 10.1818 10.182 9.20499 10.182 8.00001C10.182 6.79502 9.20516 5.81819 8.00018 5.81819C6.79519 5.81819 5.81836 6.79502 5.81836 8.00001C5.81836 9.20499 6.79519 10.1818 8.00018 10.1818Z"
                                                        stroke="#5AB1CB" stroke-linecap="round"
                                                        stroke-linejoin="round" />
                                                </g>
                                                <defs>
                                                    <clipPath id="clip0_273_132">
                                                        <rect width="15.2727" height="15.2727" fill="white"
                                                            transform="translate(0.36377 0.363632)" />
                                                    </clipPath>
                                                </defs>
                                            </svg>
                                        </div>
                                    </a>
                                    {% if session.username is defined %}
                                    <a href="controleur.php?page=documents&action=update&id={{ document.idt_doc }}">
                                        <div
                                            class="w-6 h-6 mx-2 border border-green-500 rounded flex justify-center items-center hover:bg-green-50 transition duration-200">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <g clip-path="url(#clip0_177_1499)">
                                                    <path
                                                        d="M5.81815 13.7164L0.909058 15.091L2.2836 10.1819L11.2727 1.23643C11.3743 1.13253 11.4957 1.04997 11.6295 0.993603C11.7635 0.937238 11.9074 0.908203 12.0527 0.908203C12.198 0.908203 12.3419 0.937238 12.4759 0.993603C12.6097 1.04997 12.7311 1.13253 12.8327 1.23643L14.7636 3.17825C14.8658 3.27966 14.947 3.40032 15.0024 3.53325C15.0578 3.66619 15.0863 3.80878 15.0863 3.95279C15.0863 4.0968 15.0578 4.2394 15.0024 4.37233C14.947 4.50527 14.8658 4.62593 14.7636 4.72734L5.81815 13.7164Z"
                                                        stroke="#02986A" stroke-linecap="round"
                                                        stroke-linejoin="round" />
                                                </g>
                                                <defs>
                                                    <clipPath id="clip0_177_1499">
                                                        <rect width="15.2727" height="15.2727" fill="white"
                                                            transform="translate(0.363647 0.36377)" />
                                                    </clipPath>
                                                </defs>
                                            </svg>
                                        </div>
                                    </a>
                                    {% endif %}
                                    {% if session.role_id == 1 %}
                                    <a href="controleur.php?page=documents&action=delete&id={{ document.idt_doc }}"
                                        onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet élément ?');">
                                        <div
                                            class="w-6 h-6 border border-red-500 rounded flex justify-center items-center hover:bg-red-50 transition duration-200">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <g clip-path="url(#clip0_177_1489)">
                                                    <path d="M1.45459 4.18213H14.5455" stroke="#EF4565"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                    <path
                                                        d="M3.09094 4.18213H12.9091V14.0003C12.9091 14.2896 12.7941 14.5671 12.5896 14.7717C12.3851 14.9762 12.1075 15.0912 11.8182 15.0912H4.18185C3.89252 15.0912 3.61505 14.9762 3.41046 14.7717C3.20588 14.5671 3.09094 14.2896 3.09094 14.0003V4.18213Z"
                                                        stroke="#EF4565" stroke-linecap="round"
                                                        stroke-linejoin="round" />
                                                    <path
                                                        d="M5.27283 4.18191V3.63645C5.27283 2.91314 5.56016 2.21944 6.07162 1.70798C6.58309 1.19652 7.27678 0.90918 8.0001 0.90918C8.72342 0.90918 9.41711 1.19652 9.92858 1.70798C10.44 2.21944 10.7274 2.91314 10.7274 3.63645V4.18191"
                                                        stroke="#EF4565" stroke-linecap="round"
                                                        stroke-linejoin="round" />
                                                    <path d="M6.36365 7.45605V11.8214" stroke="#EF4565"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                    <path d="M9.63635 7.45605V11.8214" stroke="#EF4565"
                                                        stroke-linecap="round" stroke-linejoin="round" />
                                                </g>
                                                <defs>
                                                    <clipPath id="clip0_177_1489">
                                                        <rect width="15.2727" height="15.2727" fill="white"
                                                            transform="translate(0.363647 0.36377)" />
                                                    </clipPath>
                                                </defs>
                                            </svg>
                                        </div>
                                    </a>

                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
                <div class="pagination flex justify-between items-center mt-4">
                    <div class="w-40 flex items-center justify-between">
                        <button id="prev-btn"
                            class="px-1 py-1 text-blue-600 rounded hover:bg-blue-50 border border-blue-300 transition duration-200">
                            <svg width="17" height="16" viewBox="0 0 17 16" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M10.4415 4.94L9.50146 4L5.50146 8L9.50146 12L10.4415 11.06L7.38813 8L10.4415 4.94Z"
                                    fill="blue" fill-opacity="0.54" />
                            </svg>
                        </button>
                        <span id="page-indicator" class="text-xs"></span>
                        <button id="next-btn"
                            class="px-1 py-1 text-blue-600 rounded hover:bg-blue-50 border border-blue-300 transition duration-200">
                            <svg width="17" height="16" viewBox="0 0 17 16" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M6.83453 4L5.89453 4.94L8.94786 8L5.89453 11.06L6.83453 12L10.8345 8L6.83453 4Z"
                                    fill="blue" fill-opacity="0.54" />
                            </svg>
                        </button>
                    </div>

                    <div class="flex items-center">
                        <label for="page-select" class="mr-2 text-xs">Aller à la page :</label>
                        <input type="number" id="page-select" min="1" max="1" value="1"
                            class="w-10 border border-blue-300 rounded px-2 py-1">
                    </div>
                </div>
            </div>

        </section>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="path/to/your/external.js"></script>
    <script>
        $(document).ready(function () {
            // Initialement cacher le tableau et montrer le loader
            $('#loader').show();
            $('#table-container').hide();
        
            // Montrer le tableau après 5 secondes et cacher le loader
            setTimeout(function () {
                $('#loader').hide();
                $('#table-container').show();
            }, 5000);
        
            const itemsPerPage = 4;
            const items = $(".document-item");
            const totalPages = Math.ceil(items.length / itemsPerPage);
            let currentPage = 1;
        
            function showLoader() {
                $("#loader").show();
            }
        
            function hideLoader() {
                $("#loader").hide();
            }
        
            function showPage(page) {
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
        
                showLoader();
                setTimeout(() => {
                    items.hide();
                    items.slice(start, end).show();
                    hideLoader();
        
                    $("#page-indicator").text(`Page ${page} / ${totalPages}`);
                    $("#page-select").val(page);
                    $("#page-select").attr("max", totalPages);
                }, 500); // Simuler un délai de chargement
            }
        
            // Cacher tous les documents au chargement de la page
            items.hide();
        
            // Afficher seulement les documents de la première page
            showPage(currentPage);
        
            $(".document-type-btn").click(function () {
                const type = $(this).data("type");
                const typeClass = `document-type-${type}`;
                const $itemsOfType = $(`.document-item[data-type="${type}"]`);
        
                if ($itemsOfType.hasClass(typeClass)) {
                    $itemsOfType.removeClass(typeClass);
                    showPage(currentPage);
                } else {
                    $itemsOfType.addClass(typeClass);
                    $itemsOfType.hide();
                    $(".document-type-btn").removeClass("active");
                    $(this).addClass("active");
                }
            });
        
            $("#prev-btn").click(function () {
                if (currentPage > 1) {
                    currentPage--;
                    showPage(currentPage);
                }
            });
        
            $("#next-btn").click(function () {
                if (currentPage < totalPages) {
                    currentPage++;
                    showPage(currentPage);
                }
            });
        
            $("#page-select").change(function () {
                const selectedPage = parseInt($(this).val(), 10);
                if (selectedPage >= 1 && selectedPage <= totalPages) {
                    currentPage = selectedPage;
                    showPage(currentPage);
                } else {
                    $(this).val(currentPage);
                }
            });
        
            var titles = [];
            {% for category_name, documents in documentsByCategory %}
            {% for document in documents %}
            titles.push("{{ document.titre|e }}");
            $(".document-item").last().attr("data-type", "{{ document.type_doc }}");
            {% endfor %}
            {% endfor %}
        
            $("#search").autocomplete({
                source: titles,
                select: function (event, ui) {
                    items.hide();
                    items.filter(function () {
                        return $(this).find('td:nth-child(2)').text() === ui.item.value;
                    }).show();
                }
            });
        });
        
        
    </script>

{% endblock %}